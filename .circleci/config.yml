version: 2.1

workflows:
  workflow:
    jobs:
      - test_python_34
      - test_old_pythons:
          matrix:
            parameters:
              python_version: ["2.7", "3.5"]
      - test:
          matrix:
            parameters:
              python_version:
                ["3.6", "3.7"]
      - test_old_pypy:
          matrix:
            parameters:
              python_version: ["2.7"]

jobs:
  # `cimg/python` doesn't support Python 3.4,
  # but old `circleci/python` is still around!
  test_python_34:
    steps:
      - checkout
      - run:
          name: Test
          command: python setup.py test
    docker:
      - image: circleci/python:3.4

  test_old_pythons: &old_python_tests
    parameters:
      python_version:
        type: string
    steps:
      - checkout
      - run:
          name: Test
          command: python setup.py test
    docker:
      - image: cimg/python:<<parameters.python_version>>

  test_old_pypy:
    <<: *old_python_tests
    docker:
      - image: pypy:<<parameters.python_version>>

  test:
    parameters:
      python_version:
        type: string
    steps:
      - checkout
      - run:
          name: Install ciso8601
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade build
            python -m build -s
            pip install dist/ciso8601-*.tar.gz
      - run:
          name: Install testing dependencies
          command: |
            . venv/bin/activate
            pip install pytz
      - run:
          name: Test
          command: |
            . venv/bin/activate
            python -m unittest
    docker:
      - image: cimg/python:<<parameters.python_version>>
